{% extends "_base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0 fw-bold">Edit Resource</h2>
  <div class="d-flex gap-2">
    <a href="{{ url_for('resources.detail', resource_id=resource.resource_id) }}" class="btn btn-outline-secondary">‚Üê Back to Resource</a>
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">Dashboard</a>
  </div>
</div>

<div class="card p-4">
  <form method="post" enctype="multipart/form-data" id="resourceForm">
    {{ form.csrf_token }}
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <label class="form-label fw-semibold">{{ form.title.label.text }}</label>
        {{ form.title(class="form-control", placeholder="Enter resource title") }}
        {% if form.title.errors %}
          <div class="text-danger small">{{ form.title.errors[0] }}</div>
        {% endif %}
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label fw-semibold">{{ form.category.label.text }}</label>
        {{ form.category(class="form-select") }}
      </div>
    </div>
    <div class="row g-3 mt-0">
      <div class="col-12 col-md-6">
        <label class="form-label fw-semibold">{{ form.location.label.text }}</label>
        {{ form.location(class="form-control", placeholder="e.g., Main Building, Room 101") }}
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label fw-semibold">{{ form.capacity.label.text }}</label>
        {{ form.capacity(class="form-control", placeholder="e.g., 30", type="number", min="1") }}
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label fw-semibold">{{ form.description.label.text }}</label>
      {{ form.description(class="form-control", rows="4", placeholder="Describe the resource...") }}
    </div>
    
    <!-- Image Upload Section -->
    <div class="mt-4">
      <label class="form-label fw-semibold">Upload New Image (Optional)</label>
      <div class="card p-3 mb-3" style="background:var(--bg-secondary);">
        <div class="mb-3">
          {{ form.image_file(class="form-control", accept="image/*") }}
          <div class="form-text mt-2">Select a new image to replace the current one. It will be automatically cropped to 16:9 aspect ratio (800x450px).</div>
          {% if form.image_file.errors %}
            <div class="text-danger small mt-2">{{ form.image_file.errors[0] }}</div>
          {% endif %}
        </div>
        {% if resource.images %}
        <div class="alert alert-info mb-3">
          <small><strong>Current Image:</strong> {{ resource.images.split(',')[0] }}</small>
        </div>
        {% endif %}
        <div id="imagePreviewContainer" style="display:none;" class="mt-3">
          <div class="alert alert-info mb-3">
            <small><strong>Preview:</strong> Your image will be automatically cropped to 16:9 ratio (800x450px) and centered.</small>
          </div>
          <div class="text-center">
            <img id="imagePreview" src="" alt="Preview" style="max-width:100%; max-height:400px; border-radius:8px; border:2px solid var(--border);">
          </div>
        </div>
      </div>
    </div>
    
    <div class="row g-3 mt-0">
      <div class="col-12 col-md-6">
        <label class="form-label fw-semibold">{{ form.restriction.label.text }}</label>
        {{ form.restriction(class="form-select") }}
        <div class="form-text">Open: Auto-approved bookings | Restricted: Requires admin approval</div>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label fw-semibold">{{ form.images.label.text }}</label>
        {{ form.images(class="form-control", placeholder="Enter a single image URL or Google Drive link") }}
        <div class="form-text">
          <small>Only one image is stored. If multiple URLs are entered, only the first will be kept. If you upload a new image above, it replaces the current one.</small>
        </div>
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label fw-semibold">{{ form.availability_rules.label.text }}</label>
      {{ form.availability_rules(class="form-control", rows="3", placeholder="e.g., Available Monday-Friday, 8 AM - 6 PM") }}
    </div>
    <div class="d-flex gap-2 mt-4">
      <button type="submit" class="btn btn-brand">Update Resource</button>
      <a href="{{ url_for('resources.detail', resource_id=resource.resource_id) }}" class="btn btn-outline-secondary">Cancel</a>
      <button type="button" class="btn btn-danger ms-auto" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete Resource</button>
    </div>
  </form>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ resource.title }}</strong>?</p>
        <p class="text-danger"><strong>Warning:</strong> This action cannot be undone. All bookings and reviews associated with this resource will also be deleted.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{{ url_for('admin.delete_resource', resource_id=resource.resource_id) }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">Delete Resource</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const imageInput = document.querySelector('input[type="file"]');
  const imagePreview = document.getElementById('imagePreview');
  const previewContainer = document.getElementById('imagePreviewContainer');
  
  if (imageInput) {
    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validate file type
        if (!file.type.match('image.*')) {
          alert('Please select an image file.');
          imageInput.value = '';
          return;
        }
        
        // Validate file size (16MB max)
        if (file.size > 16 * 1024 * 1024) {
          alert('Image size must be less than 16MB.');
          imageInput.value = '';
          return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewContainer.style.display = 'none';
      }
    });
  }
});
</script>
{% endblock %}

